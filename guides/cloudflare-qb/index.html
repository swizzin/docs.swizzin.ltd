<!doctype html>
<html class="docs-version-current" lang="en" dir="ltr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.17">
<title data-rh="true">cloudflare-qb | swizzin community edition</title><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://liaralabs.github.io/img/logo.png"><meta data-rh="true" name="twitter:image" content="https://liaralabs.github.io/img/logo.png"><meta data-rh="true" property="og:url" content="https://liaralabs.github.io/guides/cloudflare-qb"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="cloudflare-qb | swizzin community edition"><meta data-rh="true" name="description" content="This is the original write up of how to install the CloudFlare reverse proxy for Plex from the QuickBox forums. Since the forums and site are currently gone, I have decided to host it here, for posterity, for as long as this project remains on github."><meta data-rh="true" property="og:description" content="This is the original write up of how to install the CloudFlare reverse proxy for Plex from the QuickBox forums. Since the forums and site are currently gone, I have decided to host it here, for posterity, for as long as this project remains on github."><link data-rh="true" rel="icon" href="/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://liaralabs.github.io/guides/cloudflare-qb"><link data-rh="true" rel="alternate" href="https://liaralabs.github.io/guides/cloudflare-qb" hreflang="en"><link data-rh="true" rel="alternate" href="https://liaralabs.github.io/guides/cloudflare-qb" hreflang="x-default"><link rel="stylesheet" href="/assets/css/styles.89f51ffc.css">
<link rel="preload" href="/assets/js/runtime~main.67c0de8b.js" as="script">
<link rel="preload" href="/assets/js/main.c7498c1b.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function e(e){document.documentElement.setAttribute("data-theme",e)}var t=function(){var e=null;try{e=localStorage.getItem("theme")}catch(e){}return e}();null!==t?e(t):window.matchMedia("(prefers-color-scheme: dark)").matches?e("dark"):window.matchMedia("(prefers-color-scheme: light)").matches?e("light"):e("dark")}()</script><div id="__docusaurus">
<div role="region"><a href="#" class="skipToContent_ZgBM">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/logo.png" alt="swizzin Logo" class="themedImage_W2Cr themedImage--light_TfLj"><img src="/img/logo.png" alt="swizzin Logo" class="themedImage_W2Cr themedImage--dark_oUvU"></div><b class="navbar__title">swizzin</b></a><a class="navbar__item navbar__link" href="/getting-started">Docs</a><a class="navbar__item navbar__link" href="/applications">Applications</a><a class="navbar__item navbar__link" href="/dev/intro">Development</a><a class="navbar__item navbar__link" href="/getting-started/faqs">FAQs</a><a href="https://swizzin.net" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link" alt="Managed seedboxes hosted by the swizzin developers"><span>Swizzin Hosted<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/liaralabs/swizzin" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link header-github-link" aria-label="GitHub Repository"></a><div class="toggle_S7eR toggle_TdHA toggleDisabled_f9M3"><div class="toggleButton_rCf9" role="button" tabindex="-1"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_v35p"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_nQuB"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></div><input type="checkbox" checked="" class="toggleScreenReader_g2nN" aria-label="Switch between dark and light mode (currently dark mode)"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper docs-wrapper docs-doc-page"><div class="docPage_P2Lg"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_RiI4" type="button"></button><main class="docMainContainer_TCnq docMainContainerEnhanced_WDCb"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_DM6M"><div class="docItemContainer_vinB"><article><div class="theme-doc-markdown markdown"><header><h1>cloudflare-qb</h1></header><p>This is the original write up of how to install the CloudFlare reverse proxy for Plex from the QuickBox forums. Since the forums and site are currently gone, I have decided to host it here, for posterity, for as long as this project remains on github.</p><p>The following Wiki article will take you through how to Set up a CDN for Plex with CloudFlare &amp; NGINX.</p><p>Difficulty: Moderate</p><p>Requirements:</p><ul><li>A second IP (can be done with one, but not the scope of this guide)</li><li>A domain</li><li>A free CloudFlare account</li></ul><p>Caveats: CloudFlare has the effect of forcing certain levels of TLS encryption on the client. Older clients (such as some SmartTVs) do not support the minimum level of TLS required by CloudFlare, and may prevent them from being able to connect to the server. You can bypass this by rolling your own proxy where you control the level of security.</p><p>I modified this a bit from the github entry posted here along with the corresponding post on Reddit. This may take a good amount of time to setup, so make sure your read through and understand the instructions before starting! Sure this might be a bit convoluted and setting up apache and nginx to work aside each other is a bit of a pain, but with QuickBox utilizing Apache and Plex not playing well with it, there are few options.</p><p>Once you understand what‚Äôs involved, grab a cup of coffee and let‚Äôs get to work!</p><ol><li>Sign up for CloudFlare</li></ol><p>The first step is to sign up with an account at CloudFlare and move the nameservers of your domain over to the one‚Äôs provided during CloudFlare‚Äôs setup. Once CloudFlare is setup, make sure you add your failover IP to a new subdomain, i.e. plex.yourdomain.com. Until we setup Let‚Äôs Encrypt for the subdomain, ensure server traffic is not being routed through CloudFlare just yet. (grey icon) Further, under the crypto tab, ensure SSL is set to either Full or Full (Strict)</p><ol start="2"><li>Add a second IP to your server</li></ol><p>As your new nameservers propagate throughout the network, take this time to bring up the second IP on your server. We need this second IP to bind an instance of NGINX to, so that there are no conflicts with our currently running Apache server. If you want to reverse proxy apache through nginx, you could run this all off a single IP, but that won‚Äôt be covered here.</p><p>The setup of an IP may vary from host to host; however for a dedicated machine running Ubuntu, this method should work for most. A failover ip can be brought online by editing the file/etc/network/interfaces to bring a new ip address online for your network interface.</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#403f53;background-color:#FBFBFB"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#403f53"><span class="token plain">sudo nano /etc/network/interfaces</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>Insert at the bottom of interface eth0 (before ipv6 if your server supports it). Replace IP.OF.FAIL.OVER with the IP you were given by your provider and replace eth0 with the name of your adapter if necessary (e.g. enp2s0):</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#403f53;background-color:#FBFBFB"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#403f53"><span class="token plain">up ip addr add IP.OF.FAIL.OVER/32 dev eth0</span><br></span><span class="token-line" style="color:#403f53"><span class="token plain">down ip addr del IP.OF.FAIL.OVER/32 dev eth0</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>Save and exit. Bring the new interface online with the command</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#403f53;background-color:#FBFBFB"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#403f53"><span class="token plain">ip addr add IP.OF.FAIL.OVER/32 dev eth0</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>You should now be able to ping your new IP. Confirm with a local test:ping IP.OF.FAIL.OVER If your new IP fails to respond to ping, consider consulting your host‚Äôs documentation for help.</p><ol start="3"><li>Bind Apache to the main IP of your server</li></ol><p>If you don‚Äôt know the IP address of your server you can attempt to be lazy and grab it with this one-liner:</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#403f53;background-color:#FBFBFB"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#403f53"><span class="token plain">sudo ifconfig | grep -m1 &quot;inet addr&quot; | cut -d: -f2 | cut -d&quot; &quot; -f1</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>If that doesn‚Äôt work, check the email that your host sent you üòÖ</p><p>Now we need to edit two files in apache to prevent Apache2 from binding to all available interfaces:</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#403f53;background-color:#FBFBFB"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#403f53"><span class="token plain">sudo nano /etc/apache2/ports.conf</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>It should look something like this:</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#403f53;background-color:#FBFBFB"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#403f53"><span class="token plain"># If you just change the port or add more ports here, you will likely also</span><br></span><span class="token-line" style="color:#403f53"><span class="token plain"># have to change the VirtualHost statement in</span><br></span><span class="token-line" style="color:#403f53"><span class="token plain"># /etc/apache2/sites-enabled/000-default.conf</span><br></span><span class="token-line" style="color:#403f53"><span class="token plain"> </span><br></span><span class="token-line" style="color:#403f53"><span class="token plain">Listen 80</span><br></span><span class="token-line" style="color:#403f53"><span class="token plain"> </span><br></span><span class="token-line" style="color:#403f53"><span class="token plain">&lt;IfModule ssl_module&gt;</span><br></span><span class="token-line" style="color:#403f53"><span class="token plain">Listen 443</span><br></span><span class="token-line" style="color:#403f53"><span class="token plain">&lt;/IfModule&gt;</span><br></span><span class="token-line" style="color:#403f53"><span class="token plain"> </span><br></span><span class="token-line" style="color:#403f53"><span class="token plain">&lt;IfModule mod_gnutls.c&gt;</span><br></span><span class="token-line" style="color:#403f53"><span class="token plain">Listen 443</span><br></span><span class="token-line" style="color:#403f53"><span class="token plain">&lt;/IfModule&gt;</span><br></span><span class="token-line" style="color:#403f53"><span class="token plain"> </span><br></span><span class="token-line" style="color:#403f53"><span class="token plain"># vim: syntax=apache ts=4 sw=4 sts=4 sr noet</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>Alter the file as such:</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#403f53;background-color:#FBFBFB"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#403f53"><span class="token plain"># If you just change the port or add more ports here, you will likely also</span><br></span><span class="token-line" style="color:#403f53"><span class="token plain"># have to change the VirtualHost statement in</span><br></span><span class="token-line" style="color:#403f53"><span class="token plain"># /etc/apache2/sites-enabled/000-default.conf</span><br></span><span class="token-line" style="color:#403f53"><span class="token plain"> </span><br></span><span class="token-line" style="color:#403f53"><span class="token plain">Listen ORIG.IP.OF.SRV:80</span><br></span><span class="token-line" style="color:#403f53"><span class="token plain"> </span><br></span><span class="token-line" style="color:#403f53"><span class="token plain">&lt;IfModule ssl_module&gt;</span><br></span><span class="token-line" style="color:#403f53"><span class="token plain">Listen ORIG.IP.OF.SRV:443</span><br></span><span class="token-line" style="color:#403f53"><span class="token plain">&lt;/IfModule&gt;</span><br></span><span class="token-line" style="color:#403f53"><span class="token plain"> </span><br></span><span class="token-line" style="color:#403f53"><span class="token plain">&lt;IfModule mod_gnutls.c&gt;</span><br></span><span class="token-line" style="color:#403f53"><span class="token plain">Listen ORIG.IP.OF.SRV:443</span><br></span><span class="token-line" style="color:#403f53"><span class="token plain">&lt;/IfModule&gt;</span><br></span><span class="token-line" style="color:#403f53"><span class="token plain"> </span><br></span><span class="token-line" style="color:#403f53"><span class="token plain"># vim: syntax=apache ts=4 sw=4 sts=4 sr noet</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>Save, exit and load up the next file:</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#403f53;background-color:#FBFBFB"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#403f53"><span class="token plain">sudo nano /etc/apache2/sites-enabled/default-ssl.conf</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>Find the sections where it says&lt;VirtualHost <em>:80&gt; and&lt;VirtualHost </em>:443&gt;. Replace the asterisks with the ORIG.IP.OF.SRV:</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#403f53;background-color:#FBFBFB"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#403f53"><span class="token plain">...</span><br></span><span class="token-line" style="color:#403f53"><span class="token plain">&lt;VirtualHost ORIG.IP.OF.SRV:80&gt;</span><br></span><span class="token-line" style="color:#403f53"><span class="token plain">...</span><br></span><span class="token-line" style="color:#403f53"><span class="token plain">&lt;VirtualHost ORIG.IP.OF.SRV:443&gt;</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>Now, stop Apache2.</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#403f53;background-color:#FBFBFB"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#403f53"><span class="token plain">sudo systemctl stop apache2</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><ol start="4"><li>Install NGINX, Let‚Äôs Encrypt and bind to the failover IP Start by installing nginx:</li></ol><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#403f53;background-color:#FBFBFB"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#403f53"><span class="token plain">sudo apt update</span><br></span><span class="token-line" style="color:#403f53"><span class="token plain">sudo apt install nginx</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>Also, if you do not have Let‚Äôs Encrypt installed, now would be the time to do that</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#403f53;background-color:#FBFBFB"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#403f53"><span class="token plain">sudo apt install letsencrypt</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>Now, we need to alter nginx to bind to our new IP and also connect with the Let‚Äôs Encrypt servers so that they can issue you an SSL certificate.</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#403f53;background-color:#FBFBFB"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#403f53"><span class="token plain">sudo nano /etc/nginx/sites-enabled/default</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>Underneath the block you should see</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#403f53;background-color:#FBFBFB"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#403f53"><span class="token plain">server {</span><br></span><span class="token-line" style="color:#403f53"><span class="token plain">listen 80 default_server;</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>Insert your failover IP and the .well-known location for Let‚Äôs Encrypt:</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#403f53;background-color:#FBFBFB"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#403f53"><span class="token plain">server {</span><br></span><span class="token-line" style="color:#403f53"><span class="token plain">listen IP.OF.FAIL.OVER:80 default_server;</span><br></span><span class="token-line" style="color:#403f53"><span class="token plain"> </span><br></span><span class="token-line" style="color:#403f53"><span class="token plain">location ~ /.well-known {</span><br></span><span class="token-line" style="color:#403f53"><span class="token plain">allow all;</span><br></span><span class="token-line" style="color:#403f53"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>Save and exit. Run the command <code>sudo nginx -t</code> to ensure your configuration is valid. If yes, hooray! Let‚Äôs take this opportunity to restart nginx and bring our apache2 server back online.</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#403f53;background-color:#FBFBFB"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#403f53"><span class="token plain">sudo systemctl restart nginx</span><br></span><span class="token-line" style="color:#403f53"><span class="token plain">sudo systemctl restart apache2</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>Ensure there are no conflicts and both services are currently running (<code>systemctl status apache2</code> &amp; <code>systemctl status nginx</code>)</p><p>Now we can use Let‚Äôs Encrypt to grab an SSL certificate. Make sure your DNS is pointing at your failover (and not through cloudflare)</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#403f53;background-color:#FBFBFB"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#403f53"><span class="token plain">sudo letsencrypt certonly -a webroot --webroot-path=/var/www/html -d plex.yourdomain.com</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>If all goes well you now have shiny new SSL certs for plex.yourdomain.com.</p><p>Now we will beef up security just a bit more:</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#403f53;background-color:#FBFBFB"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#403f53"><span class="token plain">sudo bash</span><br></span><span class="token-line" style="color:#403f53"><span class="token plain">cd /etc/letsencrypt/live/plex.yourdomain.com/</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>Check the issuing authority of your certificate as per: source</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#403f53;background-color:#FBFBFB"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#403f53"><span class="token plain">sudo openssl x509 -noout -text -in fullchain.pem | grep Issuer:</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>You‚Äôll see something like:</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#403f53;background-color:#FBFBFB"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#403f53"><span class="token plain">Issuer: C=US, O=Let&#x27;s Encrypt, CN=Let&#x27;s Encrypt Authority X3</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>Download the corresponding pem:</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#403f53;background-color:#FBFBFB"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#403f53"><span class="token plain">wget -O chain.pem &quot;https://letsencrypt.org/certs/lets-encrypt-x3-cross-signed.pem&quot;</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>Change x3 if necessary to correlate to the authority who issued your certificate.</p><p>Now we will generate a dhparam for nginx</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#403f53;background-color:#FBFBFB"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#403f53"><span class="token plain">mkdir -p /etc/nginx/ssl</span><br></span><span class="token-line" style="color:#403f53"><span class="token plain">cd /etc/nginx/ssl</span><br></span><span class="token-line" style="color:#403f53"><span class="token plain">openssl dhparam -out dhparam.pem 2048</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>We now have everything we need to configure our Plex Reverse Proxy:</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#403f53;background-color:#FBFBFB"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#403f53"><span class="token plain">cd /etc/nginx/sites-enabled</span><br></span><span class="token-line" style="color:#403f53"><span class="token plain">wget -O plex.conf https://raw.githubusercontent.com/toomuchio/plex-nginx-reverseproxy/master/nginx.conf</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>Now we must alter the file to include our failover IP, ssl certificates and dhparam.</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#403f53;background-color:#FBFBFB"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#403f53"><span class="token plain">nano plex.conf</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>Find and insert your failover IP into the two listen parameters</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#403f53;background-color:#FBFBFB"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#403f53"><span class="token plain">listen 80;</span><br></span><span class="token-line" style="color:#403f53"><span class="token plain">listen 443 ssl http2;</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>becomes</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#403f53;background-color:#FBFBFB"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#403f53"><span class="token plain">listen IP.OF.FAIL.OVER:80;</span><br></span><span class="token-line" style="color:#403f53"><span class="token plain">listen IP.OF.FAIL.OVER:443 ssl http2;</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>Next find:</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#403f53;background-color:#FBFBFB"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#403f53"><span class="token plain">ssl_certificate</span><br></span><span class="token-line" style="color:#403f53"><span class="token plain">ssl_certificate_key</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>Insert your letsencrypt certificates here:</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#403f53;background-color:#FBFBFB"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#403f53"><span class="token plain">ssl_certificate /etc/letsencrypt/live/plex.yourdomain.com/fullchain.pem;</span><br></span><span class="token-line" style="color:#403f53"><span class="token plain">ssl_certificate_key /etc/letsencrypt/live/plex.yourdomain.com/privkey.pem;</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>Now add our trusted certificate (chain.pem):</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#403f53;background-color:#FBFBFB"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#403f53"><span class="token plain">ssl_trusted_certificate /etc/letsencrypt/live/plex.yourdomain.com/chain.pem;</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>And the dhparam a bit further down:</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#403f53;background-color:#FBFBFB"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#403f53"><span class="token plain">ssl_dhparam /etc/nginx/ssl/dhparam.pem;</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>That‚Äôs all the edits we need to make to this file so save and exit. Test your config and cross your fingers!</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#403f53;background-color:#FBFBFB"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#403f53"><span class="token plain">nginx -t</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>If all goes well, start your server</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#403f53;background-color:#FBFBFB"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#403f53"><span class="token plain">systemctl start nginx</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>Now your Plex should be accessible via<a href="https://plex.yourdomain.com" target="_blank" rel="noopener noreferrer">https://plex.yourdomain.com</a></p><ol start="5"><li>Alter your Plex Server settings</li></ol><p>Make sure ‚ÄúShow Advanced Settings‚Äù is on. Under the Network tab add a custom access url:</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#403f53;background-color:#FBFBFB"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#403f53"><span class="token plain">https://plex.yourdomain.com:443</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>Under Remote Access, disable remote access</p><ol start="6"><li>Update firewall to prevent external pinging of port 32400</li></ol><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#403f53;background-color:#FBFBFB"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#403f53"><span class="token plain">iptables -A INPUT -p tcp -s localhost --dport 32400 -j ACCEPT</span><br></span><span class="token-line" style="color:#403f53"><span class="token plain">iptables -A INPUT -p tcp --dport 32400 -j DROP</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>The first rule ensures our localhost is still able to talk with Plex. This allows our proxy to communicate, with the internal server, but the second rule prevents all other access. As such, you should still be able to access your plex installation from both plex.tv/web/app and plex.yourdomain.com. Confirm you are able to, then once you have, ensure these rules stay persistent upon a reboot with iptables-persistent:</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#403f53;background-color:#FBFBFB"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#403f53"><span class="token plain">apt install iptables-persistent</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>Choose yes during installation to save your current iptables (note if you have any fail2ban rules, they may get included in here. Make sure you have no firewall rules you don‚Äôt want to save, though you can remove unintentional additions if needed.</p><p>At this point, no data should be served from your server via port 32400 and all traffic should flow exclusively through port 443 (you can verify this with tcptrack ‚Äì your server will not establish connections via port 32400 during playback though it will try- SYN_CONNECT).</p><ol start="7"><li>Enable CloudFlare CDN for plex.mydomain.com</li></ol><p>Change over that grey cloud icon to the orange one!</p><p>Your data is now being proxied through CloudFlare‚Äôs servers. Congratulations!! Once the DNS switches over to your CloudFlare IP you should see a noticeable improvement in your speeds and jitter.</p><p>Please note this may not be perfect ‚Äì I will do my best to answer questions and update and errors in the guide. Please let me know if you run into issues!</p><p>If you‚Äôre worried about sending all of your data through cloudflare, the same basic principle could apply to a VPS such as Linode, Vultr or other.</p></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="theme-doc-footer-edit-meta-row row"><div class="col"><a href="https://github.com/liaralabs/docs.swizzin.ltd/edit/master/docs/guides/cloudflare-qb.md" target="_blank" rel="noreferrer noopener" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_dcUD" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_foO9"></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages navigation"><div class="pagination-nav__item"></div><div class="pagination-nav__item pagination-nav__item--next"></div></nav></div></div></div></div></main></div></div><footer class="footer"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">swizzin</div><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/getting-started">Getting Started</a></li><li class="footer__item"><a class="footer__link-item" href="/getting-started/box-basics">Box Basics</a></li></ul></div><div class="col footer__col"><div class="footer__title">Social</div><ul class="footer__items"><li class="footer__item"><a href="https://github.com/liaralabs/swizzin" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li><li class="footer__item"><a href="https://discord.gg/sKjs9UM" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>Discord<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li></ul></div></div><div class="footer__bottom text--center"><div class="margin-bottom--sm"><a href="https://swizzin.ltd" target="_blank" rel="noopener noreferrer" class="footerLogoLink_RC3H"><img src="/img/logo-sm.png" alt="swizzin Logo" class="themedImage_W2Cr themedImage--light_TfLj footer__logo"><img src="/img/logo-sm.png" alt="swizzin Logo" class="themedImage_W2Cr themedImage--dark_oUvU footer__logo"></a></div><div class="footer__copyright">Copyright ¬© 2022 swizzin. All rights reserved.</div></div></div></footer></div>
<script src="/assets/js/runtime~main.67c0de8b.js"></script>
<script src="/assets/js/main.c7498c1b.js"></script>
</body>
</html>