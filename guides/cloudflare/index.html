<!doctype html>
<html lang="en" dir="ltr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.4">
<link rel="preconnect" href="https://www.google-analytics.com">
<script>window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)},ga.l=+new Date,ga("create","UA-104631777-1","auto"),ga("send","pageview")</script>
<script async src="https://www.google-analytics.com/analytics.js"></script>
<link rel="search" type="application/opensearchdescription+xml" title="swizzin community edition" href="/opensearch.xml"><title data-react-helmet="true">cloudflare | swizzin community edition</title><meta data-react-helmet="true" name="twitter:card" content="summary_large_image"><meta data-react-helmet="true" property="og:url" content="https://liaralabs.github.io/guides/cloudflare"><meta data-react-helmet="true" name="docsearch:language" content="en"><meta data-react-helmet="true" name="docsearch:version" content="current"><meta data-react-helmet="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-react-helmet="true" property="og:title" content="cloudflare | swizzin community edition"><meta data-react-helmet="true" name="description" content="The following Wiki article will take you through how to Set up a CDN for Plex with CloudFlare &amp; swizzin."><meta data-react-helmet="true" property="og:description" content="The following Wiki article will take you through how to Set up a CDN for Plex with CloudFlare &amp; swizzin."><meta data-react-helmet="true" property="og:image" content="https://liaralabs.github.io/img/logo.png"><meta data-react-helmet="true" name="twitter:image" content="https://liaralabs.github.io/img/logo.png"><link data-react-helmet="true" rel="shortcut icon" href="/img/favicon.ico"><link data-react-helmet="true" rel="canonical" href="https://liaralabs.github.io/guides/cloudflare"><link data-react-helmet="true" rel="alternate" href="https://liaralabs.github.io/guides/cloudflare" hreflang="en"><link data-react-helmet="true" rel="alternate" href="https://liaralabs.github.io/guides/cloudflare" hreflang="x-default"><link data-react-helmet="true" rel="preconnect" href="https://BH4D9OD16A-dsn.algolia.net" crossorigin="anonymous"><link rel="stylesheet" href="/assets/css/styles.6a68138d.css">
<link rel="preload" href="/assets/js/runtime~main.a18f9703.js" as="script">
<link rel="preload" href="/assets/js/main.6dba35c4.js" as="script">
</head>
<body>
<script>!function(){function e(e){document.documentElement.setAttribute("data-theme",e)}var t=function(){var e=null;try{e=localStorage.getItem("theme")}catch(e){}return e}();null!==t?e(t):window.matchMedia("(prefers-color-scheme: dark)").matches?e("dark"):window.matchMedia("(prefers-color-scheme: light)").matches?e("light"):e("dark")}()</script><div id="__docusaurus">
<div><a href="#" class="skipToContent_1oUP">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><img src="/img/logo.png" alt="swizzin Logo" class="themedImage_1VuW themedImage--light_3UqQ navbar__logo"><img src="/img/logo.png" alt="swizzin Logo" class="themedImage_1VuW themedImage--dark_hz6m navbar__logo"><b class="navbar__title">swizzin</b></a><a class="navbar__item navbar__link" href="/getting-started">Docs</a><a class="navbar__item navbar__link" href="/applications">Applications</a><a class="navbar__item navbar__link" href="/dev/intro">Development</a><a class="navbar__item navbar__link" href="/getting-started/faqs">FAQs</a><a href="https://swizzin.net" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link" alt="Managed seedboxes hosted by the swizzin developers"><span>Swizzin Hosted<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/liaralabs/swizzin" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link header-github-link" aria-label="GitHub Repository"></a><div class="react-toggle toggle_3Zt9 react-toggle--checked react-toggle--disabled"><div class="react-toggle-track" role="button" tabindex="-1"><div class="react-toggle-track-check"><span class="toggle_71bT" style="margin-left:2px">üåô</span></div><div class="react-toggle-track-x"><span class="toggle_71bT" style="margin-left:1px">‚òÄÔ∏è</span></div><div class="react-toggle-thumb"></div></div><input type="checkbox" checked="" class="react-toggle-screenreader-only" aria-label="Switch between dark and light mode"></div><div class="searchBox_1Doo"><button type="button" class="DocSearch DocSearch-Button" aria-label="Search"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">Search</span></span><span class="DocSearch-Button-Keys"></span></button></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper docs-wrapper doc-page"><div class="docPage_31aa"><button class="clean-btn backToTopButton_35hR" type="button" title="Scroll to top"><svg viewBox="0 0 24 24" width="28"><path d="M7.41 15.41L12 10.83l4.59 4.58L18 14l-6-6-6 6z" fill="currentColor"></path></svg></button><main class="docMainContainer_3ufF docMainContainerEnhanced_3NYZ"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_3FnS"><div class="docItemContainer_33ec"><article><div class="markdown"><header><h1 class="h1Heading_27L5">cloudflare</h1></header><p>The following Wiki article will take you through how to Set up a CDN for Plex with CloudFlare &amp; swizzin.</p><p>Difficulty: Easy (easier than a QuickBox install, for sure!)</p><p>Requirements:</p><ul><li>A domain</li><li>A free CloudFlare account</li></ul><p>Caveats: CloudFlare has the effect of forcing certain levels of TLS encryption on the client. Older clients (such as some SmartTVs) do not support the minimum level of TLS required by CloudFlare, and may prevent them from being able to connect to the server. You can bypass this by rolling your own proxy where you control the level of security.</p><p>I modified this a bit from the github entry posted here along with the corresponding post on Reddit and my old QuickBox guide. This may take a some time to setup, so make sure your read through and understand the instructions before starting!</p><p>Once you understand what‚Äôs involved, grab a cup of coffee and let‚Äôs get to work!</p><ol><li>Sign up for CloudFlare</li></ol><p>The first step is to sign up with an account at CloudFlare and move the nameservers of your domain over to the one‚Äôs provided during CloudFlare‚Äôs setup. Once CloudFlare is setup, make sure you add your server&#x27;s IP to a new subdomain, i.e. plex.yourdomain.com. Make sure to turn on routing to CloudFlare (orange cloud icon). Further, under the crypto tab, ensure SSL is set to either Full or Full (Strict)</p><ol start="2"><li>Grab the SSL certificate for your domain:</li></ol><p>First install acme.sh if you have not run the let&#x27;s encrypt installer from swizzin yet. Ignore the warning about socat if you receive one. We will not be using the standalone webserver to issue certificates</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><pre tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar" style="color:#403f53;background-color:#FBFBFB"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#403f53"><span class="token plain">curl https://get.acme.sh | sh</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>Now, we will issue a certificate, but first we will define a couple variables:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><pre tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar" style="color:#403f53;background-color:#FBFBFB"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#403f53"><span class="token plain">hostname={YOUR HOSTNAME. eg plex.yourdomain.com}</span></span><span class="token-line" style="color:#403f53"><span class="token plain">export CF_Key={YOUR CF API KEY}</span></span><span class="token-line" style="color:#403f53"><span class="token plain">export CF_Email={YOUR CF EMAIL}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>Once you have defined these variables then get the certificates and install them to your nginx directory. You can copy and paste these commands if you have defined your variables correctly, as above:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><pre tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar" style="color:#403f53;background-color:#FBFBFB"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#403f53"><span class="token plain">mkdir -p /etc/nginx/ssl/${hostname}</span></span><span class="token-line" style="color:#403f53"><span class="token plain">/root/.acme.sh/acme.sh --issue --dns dns_cf -d ${hostname}</span></span><span class="token-line" style="color:#403f53"><span class="token plain">/root/.acme.sh/acme.sh --install-cert -d ${hostname} --key-file /etc/nginx/ssl/${hostname}/key.pem --fullchain-file /etc/nginx/ssl/${hostname}/fullchain.pem --ca-file /etc/nginx/ssl/${hostname}/chain.pem --reloadcmd &quot;service nginx force-reload&quot;</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>We now have everything we need to configure our Plex Reverse Proxy:</p><ol start="3"><li>Configure nginx</li></ol><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><pre tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar" style="color:#403f53;background-color:#FBFBFB"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#403f53"><span class="token plain">cd /etc/nginx/sites-enabled</span></span><span class="token-line" style="color:#403f53"><span class="token plain">wget -O plex.conf https://raw.githubusercontent.com/toomuchio/plex-nginx-reverseproxy/master/nginx.conf</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>Now we must alter the file to include our failover IP, ssl certificates and dhparam.</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><pre tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar" style="color:#403f53;background-color:#FBFBFB"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#403f53"><span class="token plain">nano plex.conf</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>Find:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><pre tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar" style="color:#403f53;background-color:#FBFBFB"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#403f53"><span class="token plain">server_name</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>and replace plex.EXAMPLE.COM with your own hostname</p><p>Then find:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><pre tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar" style="color:#403f53;background-color:#FBFBFB"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#403f53"><span class="token plain">ssl_certificate</span></span><span class="token-line" style="color:#403f53"><span class="token plain">ssl_certificate_key</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>Insert your letsencrypt certificates here:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><pre tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar" style="color:#403f53;background-color:#FBFBFB"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#403f53"><span class="token plain">ssl_certificate /etc/nginx/ssl/{YOUR HOSTNAME}/fullchain.pem;</span></span><span class="token-line" style="color:#403f53"><span class="token plain">ssl_certificate_key /etc/nginx/ssl/{YOUR HOSTNAME}/key.pem;</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>Now add our trusted certificate (chain.pem):</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><pre tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar" style="color:#403f53;background-color:#FBFBFB"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#403f53"><span class="token plain">ssl_trusted_certificate /etc/nginx/ssl/{YOUR HOSTNAME}/chain.pem;</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>And the dhparam already generated on a default swizzin install a bit further down:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><pre tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar" style="color:#403f53;background-color:#FBFBFB"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#403f53"><span class="token plain">ssl_dhparam /etc/nginx/ssl/dhparam.pem;</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>That‚Äôs all the edits we need to make to this file so save and exit. Test your config and cross your fingers!</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><pre tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar" style="color:#403f53;background-color:#FBFBFB"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#403f53"><span class="token plain">nginx -t</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>If all goes well, reload your server configuration</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><pre tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar" style="color:#403f53;background-color:#FBFBFB"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#403f53"><span class="token plain">systemctl reload nginx</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>Now your Plex should be accessible via <a href="https://plex.yourdomain.com" target="_blank" rel="noopener noreferrer">https://plex.yourdomain.com</a></p><ol start="4"><li>Alter your Plex Server settings</li></ol><p>Make sure ‚ÄúShow Advanced Settings‚Äù is on. Under the Network tab add a custom access url:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><pre tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar" style="color:#403f53;background-color:#FBFBFB"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#403f53"><span class="token plain">http://plex.yourdomain.com:80,https://plex.yourdomain.com:443</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>Under Remote Access, disable remote access</p><ol start="5"><li>Update firewall to prevent external pinging of port 32400</li></ol><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><pre tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar" style="color:#403f53;background-color:#FBFBFB"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#403f53"><span class="token plain">iptables -A INPUT -p tcp -s localhost --dport 32400 -j ACCEPT</span></span><span class="token-line" style="color:#403f53"><span class="token plain">iptables -A INPUT -p tcp --dport 32400 -j DROP</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>The first rule ensures our localhost is still able to talk with Plex. This allows our proxy to communicate, with the internal server, but the second rule prevents all other access. As such, you should still be able to access your plex installation from both plex.tv/web/app and plex.yourdomain.com. Confirm you are able to, then once you have, ensure these rules stay persistent upon a reboot with iptables-persistent:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><pre tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar" style="color:#403f53;background-color:#FBFBFB"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#403f53"><span class="token plain">apt install iptables-persistent</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>Choose yes during installation to save your current iptables (note if you have any fail2ban rules, they may get included in here. Make sure you have no firewall rules you don‚Äôt want to save, though you can remove unintentional additions if needed.</p><p>At this point, no data should be served from your server via port 32400 and all traffic should flow exclusively through port 443 (you can verify this with tcptrack ‚Äì your server will not establish connections via port 32400 during playback though it will try- SYN_CONNECT).</p><ol start="6"><li>Test and enjoy!</li></ol><p>Please note this may not be perfect ‚Äì I will do my best to answer questions and update and errors in the guide. Please let me know if you run into issues!</p><p>If you‚Äôre worried about sending all of your data through cloudflare, the same basic principle could apply to a VPS such as Linode, Vultr or other.</p></div><footer class="row docusaurus-mt-lg"><div class="col"><a href="https://github.com/liaralabs/docs.swizzin.ltd/edit/master/docs/guides/cloudflare.md" target="_blank" rel="noreferrer noopener"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_2_ui" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_3DPF"></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages navigation"><div class="pagination-nav__item"></div><div class="pagination-nav__item pagination-nav__item--next"></div></nav></div></div></div></div></main></div></div><footer class="footer"><div class="container"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">swizzin</div><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/getting-started">Getting Started</a></li><li class="footer__item"><a class="footer__link-item" href="/getting-started/box-basics">Box Basics</a></li></ul></div><div class="col footer__col"><div class="footer__title">Social</div><ul class="footer__items"><li class="footer__item"><a href="https://github.com/liaralabs/swizzin" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li><li class="footer__item"><a href="https://discord.gg/sKjs9UM" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>Discord<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li></ul></div></div><div class="footer__bottom text--center"><div class="margin-bottom--sm"><a href="https://swizzin.ltd" target="_blank" rel="noopener noreferrer" class="footerLogoLink_MyFc"><img src="/img/logo-sm.png" alt="swizzin Logo" class="themedImage_1VuW themedImage--light_3UqQ footer__logo"><img src="/img/logo-sm.png" alt="swizzin Logo" class="themedImage_1VuW themedImage--dark_hz6m footer__logo"></a></div><div class="footer__copyright">Copyright ¬© 2021 swizzin. All rights reserved.</div></div></div></footer></div>
<script src="/assets/js/runtime~main.a18f9703.js"></script>
<script src="/assets/js/main.6dba35c4.js"></script>
</body>
</html>